<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–¥—É–∫—Ç—ñ–≤</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #faf7f0;
    --parchment: #f2ead8;
    --warm-white: #fffef9;
    --ink: #1a1510;
    --brown: #3d2b1a;
    --amber: #c8702a;
    --amber-light: #e8944a;
    --sage: #5a7a5c;
    --sage-light: #7aaa7d;
    --red: #c0392b;
    --red-light: #e74c3c;
    --gold: #b8943a;
    --gold-light: #d4aa50;
    --blue-cold: #2e6b9e;
    --blue-light: #4a8fc0;
    --border: rgba(61,43,26,0.12);
    --shadow: 0 4px 24px rgba(26,21,16,0.08);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  /* Subtle grain texture */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  /* HEADER */
  header {
    position: sticky; top: 0; z-index: 100;
    background: var(--brown);
    padding: 0 32px;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.2);
  }

  .logo {
    display: flex; align-items: center; gap: 14px;
  }

  .logo-emblem {
    font-size: 26px; line-height: 1;
  }

  .logo-text h1 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--parchment);
    letter-spacing: 1px;
    line-height: 1;
  }

  .logo-text p {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 4px;
    text-transform: uppercase;
    color: var(--gold-light);
    margin-top: 2px;
  }

  .header-right {
    display: flex; align-items: center; gap: 24px;
  }

  #clock {
    font-size: 15px;
    font-weight: 600;
    color: var(--parchment);
    letter-spacing: 2px;
  }

  #date-disp {
    font-size: 12px;
    color: var(--gold-light);
    font-weight: 400;
  }

  /* MAIN */
  .page {
    position: relative; z-index: 1;
    max-width: 1480px;
    margin: 0 auto;
    padding: 28px 24px;
  }

  /* PAGE TITLE */
  .page-header {
    display: flex; align-items: flex-end; justify-content: space-between;
    margin-bottom: 24px;
  }

  .page-title {
    font-family: 'Playfair Display', serif;
    font-size: 36px;
    font-weight: 900;
    color: var(--brown);
    line-height: 1;
  }

  .page-subtitle {
    font-size: 13px;
    color: var(--amber);
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 4px;
  }

  /* STAT CARDS */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 18px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(26,21,16,0.12); }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--amber);
  }

  .stat-card.s-cold::before { background: var(--blue-cold); }
  .stat-card.s-warn::before { background: var(--gold); }
  .stat-card.s-danger::before { background: var(--red); }
  .stat-card.s-ok::before { background: var(--sage); }

  .stat-icon { font-size: 22px; margin-bottom: 8px; }
  .stat-label { font-size: 10px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: #888; margin-bottom: 4px; }
  .stat-val { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 700; color: var(--ink); line-height: 1; }
  .stat-card.s-warn .stat-val { color: var(--gold); }
  .stat-card.s-danger .stat-val { color: var(--red); }

  /* LAYOUT */
  .layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    align-items: start;
  }

  /* CARD */
  .card {
    background: var(--warm-white);
    border: 1px solid var(--border);
    border-radius: 10px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--parchment);
    display: flex; align-items: center; gap: 10px;
  }

  .card-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--brown);
  }

  .card-header .icon { font-size: 18px; }

  .card-body { padding: 20px; }

  /* FORM */
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .fg { margin-bottom: 12px; }

  .fg label {
    display: block;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #888;
    margin-bottom: 5px;
  }

  .fg input, .fg select {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    -webkit-appearance: none;
  }

  .fg input:focus, .fg select:focus {
    border-color: var(--amber);
    box-shadow: 0 0 0 3px rgba(200,112,42,0.12);
    background: var(--warm-white);
  }

  .btn {
    width: 100%;
    padding: 11px;
    background: var(--brown);
    color: var(--parchment);
    border: none;
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }

  .btn:hover {
    background: var(--amber);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(200,112,42,0.3);
  }

  .btn.btn-sm {
    width: auto;
    padding: 5px 12px;
    font-size: 12px;
    border-radius: 4px;
  }

  .btn.btn-outline-red {
    background: transparent;
    border: 1.5px solid #e8d5d5;
    color: var(--red);
  }
  .btn.btn-outline-red:hover { background: var(--red); color: #fff; box-shadow: 0 4px 16px rgba(192,57,43,0.3); }

  .btn.btn-outline-gold {
    background: transparent;
    border: 1.5px solid #e8dfc8;
    color: var(--gold);
  }
  .btn.btn-outline-gold:hover { background: var(--gold); color: #fff; box-shadow: 0 4px 16px rgba(184,148,58,0.3); }

  /* ZONE TABS */
  .zone-tabs {
    display: flex; flex-wrap: wrap; gap: 6px;
    margin-bottom: 14px;
  }

  .ztab {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: transparent;
    color: #888;
    font-family: 'DM Sans';
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 5px;
  }

  .ztab:hover { border-color: var(--amber); color: var(--amber); }
  .ztab.active { background: var(--brown); border-color: var(--brown); color: var(--parchment); }

  /* SEARCH */
  .search-bar {
    position: relative; margin-bottom: 14px;
  }

  .search-bar input {
    width: 100%;
    padding: 10px 14px 10px 38px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans'; font-size: 13px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .search-bar input:focus {
    border-color: var(--amber);
    box-shadow: 0 0 0 3px rgba(200,112,42,0.1);
    background: var(--warm-white);
  }

  .search-bar .s-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    font-size: 15px; pointer-events: none;
  }

  /* FILTER PILLS */
  .filter-row {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .filter-label { font-size: 11px; font-weight: 600; color: #aaa; letter-spacing: 1px; }

  .fpill {
    padding: 4px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: #777;
    font-size: 11px; font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .fpill:hover { border-color: var(--amber); color: var(--amber); }
  .fpill.active { background: var(--red-light); border-color: var(--red-light); color: #fff; }
  .fpill.active.warn { background: var(--gold); border-color: var(--gold); }
  .fpill.active.expire { background: #e67e22; border-color: #e67e22; }

  /* TABLE */
  .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }

  thead { background: var(--parchment); }

  thead th {
    padding: 11px 14px;
    text-align: left;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #888;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
    border-bottom: 1px solid var(--border);
  }

  thead th:hover { color: var(--amber); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
    animation: rowIn 0.25s ease;
  }

  @keyframes rowIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  tbody tr:hover { background: rgba(200,112,42,0.04); }
  tbody tr:last-child { border-bottom: none; }

  td { padding: 12px 14px; vertical-align: middle; }

  .prod-name {
    font-weight: 600;
    color: var(--ink);
    display: block;
  }

  .prod-cat {
    font-size: 11px;
    color: #aaa;
    margin-top: 2px;
  }

  /* Zone badges */
  .zbadge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
  }

  .z-cold   { background: #ddeef8; color: var(--blue-cold); }
  .z-freeze { background: #dde8f5; color: #1a4a7a; }
  .z-dry    { background: #f5edda; color: var(--gold); }
  .z-bar    { background: #fde9d9; color: var(--amber); }
  .z-kitchen{ background: #e8f5e8; color: var(--sage); }
  .z-wine   { background: #f5e0e8; color: #a0304a; }

  /* Qty */
  .qty-wrap { text-align: right; }
  .qty-num {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: var(--ink);
    line-height: 1;
  }
  .qty-num.low { color: var(--gold); }
  .qty-num.empty { color: var(--red); }
  .qty-unit { font-size: 10px; color: #aaa; font-weight: 500; }

  /* Expiry */
  .expiry-cell { font-size: 12px; white-space: nowrap; }
  .exp-ok { color: var(--sage); font-weight: 600; }
  .exp-soon { color: #e67e22; font-weight: 700; }
  .exp-expired { color: var(--red); font-weight: 700; }
  .exp-none { color: #ccc; }

  .exp-days {
    font-size: 10px;
    margin-top: 2px;
    display: block;
  }

  /* Status */
  .sbadge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .sb-ok { background: #e8f5e8; color: var(--sage); }
  .sb-low { background: #fef5e0; color: var(--gold); }
  .sb-empty { background: #fde8e8; color: var(--red); }
  .sb-expire { background: #fde8cc; color: #c0601a; }

  .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-ok { background: var(--sage); animation: blink 3s infinite; }
  .dot-low { background: var(--gold); animation: blink 2s infinite; }
  .dot-empty { background: var(--red); animation: blink 1s infinite; }
  .dot-expire { background: #e67e22; animation: blink 1.5s infinite; }

  @keyframes blink {
    0%,100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .row-actions { display: flex; gap: 5px; align-items: center; }

  /* Empty */
  .empty-state {
    text-align: center;
    padding: 60px;
    color: #ccc;
  }

  .empty-state .e-icon { font-size: 52px; margin-bottom: 12px; opacity: 0.5; }
  .empty-state p { font-size: 14px; letter-spacing: 1px; }

  /* MODAL */
  .overlay {
    position: fixed; inset: 0;
    background: rgba(26,21,16,0.5);
    backdrop-filter: blur(6px);
    z-index: 999;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
  }

  .overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--warm-white);
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    width: 480px; max-width: 95vw;
    max-height: 90vh; overflow-y: auto;
    transform: scale(0.96) translateY(10px);
    transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
  }

  .overlay.open .modal { transform: scale(1) translateY(0); }

  .modal-head {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--parchment);
    border-radius: 12px 12px 0 0;
  }

  .modal-head h3 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    color: var(--brown);
  }

  .modal-body { padding: 24px; }

  .modal-foot {
    display: flex; gap: 8px;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
  }

  .modal-foot .btn { flex: 1; }

  .btn-ghost {
    background: transparent;
    border: 1.5px solid var(--border);
    color: #888;
  }

  .btn-ghost:hover { background: var(--parchment); box-shadow: none; transform: none; border-color: #ccc; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--brown);
    color: var(--parchment);
    padding: 14px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    z-index: 9999;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    transform: translateY(80px) scale(0.95);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
    max-width: 320px;
    border-left: 4px solid var(--amber);
  }

  .toast.show { transform: translateY(0) scale(1); opacity: 1; }
  .toast.err { border-left-color: var(--red); }
  .toast.ok { border-left-color: var(--sage); }

  /* PROGRESS BAR */
  .qty-bar {
    height: 3px;
    background: #e8e0d0;
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
  }

  .qty-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.4s ease;
  }

  @media (max-width: 1024px) {
    .layout { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(3, 1fr); }
  }

  /* ===== MOBILE SIDEBAR TOGGLE ===== */
  .sidebar-toggle {
    display: none;
    align-items: center; gap: 8px;
    padding: 10px 14px;
    background: var(--parchment);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 13px; font-weight: 600;
    color: var(--brown);
    cursor: pointer;
    width: 100%;
    margin-bottom: 12px;
    transition: background 0.15s;
  }
  .sidebar-toggle:hover { background: #ede4cc; }
  .sidebar-toggle .arrow { margin-left: auto; transition: transform 0.25s; }
  .sidebar-toggle.open .arrow { transform: rotate(180deg); }
  .sidebar-collapsible { transition: max-height 0.35s ease, opacity 0.25s; overflow: hidden; }

  /* ===== TABLET ===== */
  @media (max-width: 768px) {
    /* Stats */
    .stats-row { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .stat-val { font-size: 28px; }

    /* Layout */
    .layout { grid-template-columns: 1fr; gap: 12px; }
    .sidebar-toggle { display: flex; }

    /* Page */
    .page { padding: 14px 12px; }
    .page-title { font-size: 26px; }
    .page-subtitle { font-size: 11px; letter-spacing: 1px; }
    .page-header { flex-wrap: wrap; gap: 10px; margin-bottom: 16px; }
    .page-header .btn { width: 100%; text-align: center; }

    /* Zone tabs scroll */
    .zone-tabs { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; gap: 5px; scrollbar-width: none; }
    .zone-tabs::-webkit-scrollbar { display: none; }
    .ztab { flex-shrink: 0; font-size: 11px; padding: 5px 10px; }

    /* Filters */
    .filter-row { gap: 5px; flex-wrap: wrap; }
    .fpill { font-size: 11px; padding: 5px 10px; }

    /* Modals */
    .overlay { align-items: flex-end; padding: 0; }
    .modal { 
      width: 100% !important; 
      max-width: 100% !important;
      max-height: 90vh; 
      margin: 0;
      border-radius: 20px 20px 0 0;
      overflow-y: auto;
    }
    .modal-body { padding: 16px; }
    .modal-head { padding: 16px 16px 12px; }
    .modal-foot { padding: 12px 16px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }

    /* Card body */
    .card-body { padding: 12px 14px; }

    /* Telegram bar fixed bottom */
    .tg-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 200;
      border-radius: 0;
      padding: 10px 14px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      box-shadow: 0 -3px 16px rgba(0,0,0,0.12);
      gap: 8px;
    }
    .tg-bar-label { display: none; }
    .tg-count { flex: 1; min-width: 0; }
    .btn-tg { padding: 9px 14px; font-size: 12px; }
    .btn-tg-settings { padding: 8px 11px; font-size: 11px; }
    body { padding-bottom: 72px; }
  }

  /* ===== MOBILE TABLE ‚Üí CARDS ===== */
  @media (max-width: 768px) {
    .table-wrap table { display: block; }
    .table-wrap table thead { display: none; }
    .table-wrap table tbody { display: block; }

    /* Each row = card */
    .table-wrap table tbody tr {
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto auto auto;
      padding: 14px;
      border-bottom: 1px solid var(--border);
      gap: 4px 8px;
      position: relative;
      background: var(--warm-white);
    }
    .table-wrap table tbody tr:nth-child(even) { background: var(--cream); }

    .table-wrap table tbody tr td {
      display: block;
      padding: 0;
      border: none;
    }

    /* Row 1 left: product name */
    .table-wrap table tbody tr td:nth-child(1) {
      grid-column: 1; grid-row: 1;
      padding-right: 80px;
    }
    .prod-name { font-size: 15px; font-weight: 600; }
    .prod-cat { font-size: 11px; }

    /* Row 1 right: action buttons */
    .table-wrap table tbody tr td:nth-child(8) {
      grid-column: 2; grid-row: 1;
      display: flex; gap: 4px; align-items: flex-start;
      position: absolute; top: 12px; right: 12px;
    }

    /* Row 2: zone + status */
    .table-wrap table tbody tr td:nth-child(2) { grid-column: 1; grid-row: 2; }
    .table-wrap table tbody tr td:nth-child(5) { grid-column: 2; grid-row: 2; justify-self: end; }

    /* Row 3: qty + expiry */
    .table-wrap table tbody tr td:nth-child(3) { grid-column: 1; grid-row: 3; }
    .table-wrap table tbody tr td:nth-child(4) { grid-column: 2; grid-row: 3; justify-self: end; text-align: right; }
    .qty-wrap { display: flex; align-items: center; gap: 8px; }
    .qty-num { font-size: 18px; }

    /* Row 4: order flags + qty input */
    .table-wrap table tbody tr td:nth-child(6) { grid-column: 1; grid-row: 4; }
    .table-wrap table tbody tr td:nth-child(7) { grid-column: 2; grid-row: 4; justify-self: end; }

    /* Bigger touch targets for flags */
    .flag-btn { width: 38px; height: 38px; font-size: 17px; }
    .btn.btn-sm { padding: 7px 13px; font-size: 12px; min-height: 34px; }
    .order-qty-inp { width: 74px; font-size: 14px; padding: 7px 8px; }

    /* Zone badge smaller */
    .zbadge { font-size: 11px; padding: 3px 8px; }

    /* Status badge */
    .sbadge { font-size: 9px; padding: 3px 7px; }

    /* Expiry compact */
    .exp-ok, .exp-soon, .exp-expired, .exp-none { font-size: 11px; }
    .exp-days { display: block; font-size: 10px; }
  }

  /* ===== SMALL PHONES ===== */
  @media (max-width: 400px) {
    .page { padding: 10px 8px; }
    .page-title { font-size: 22px; }
    .stats-row { gap: 6px; }
    .stat-val { font-size: 22px; }
    .stat-icon { font-size: 16px; }
    .stat-label { font-size: 9px; }
    .stat-card { padding: 12px 10px; }
  }

  /* ===== HEADER MOBILE ===== */
  @media (max-width: 768px) {
    header { 
      padding: 0 14px; 
      height: 52px;
    }
    .logo { gap: 10px; }
    .logo-emblem { font-size: 20px; }
    .logo-text h1 { font-size: 15px; letter-spacing: 0.5px; }
    .logo-text p { display: none; }
    #clock { font-size: 13px; letter-spacing: 1px; }
    #date-disp { display: none; }
    .header-right { gap: 10px; }
    #sync-badge { padding: 5px 8px; gap: 5px; }
    #sync-label { display: none; }
  }

  /* ===== ORDER FLAGS ===== */
  .order-col { text-align: center; white-space: nowrap; }

  .flag-btn {
    display: inline-flex; align-items: center; justify-content: center;
    width: 30px; height: 30px;
    border-radius: 6px;
    border: 1.5px solid var(--border);
    background: transparent;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.15s;
    flex-shrink: 0;
  }

  .flag-btn:hover { transform: scale(1.15); }

  .flag-btn.soon-active {
    background: #fef5e0;
    border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(184,148,58,0.2);
  }

  .flag-btn.urgent-active {
    background: #fde8e8;
    border-color: var(--red);
    box-shadow: 0 0 0 2px rgba(192,57,43,0.2);
    animation: pulse-urgent 1.5s infinite;
  }

  @keyframes pulse-urgent {
    0%,100% { box-shadow: 0 0 0 2px rgba(192,57,43,0.2); }
    50%      { box-shadow: 0 0 0 5px rgba(192,57,43,0.08); }
  }

  .order-qty-inp {
    width: 64px;
    padding: 5px 7px;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .order-qty-inp:focus {
    border-color: var(--amber);
    box-shadow: 0 0 0 3px rgba(200,112,42,0.12);
    background: var(--warm-white);
  }

  .order-qty-inp.has-val { border-color: var(--sage); background: #f0faf0; }

  .flags-wrap { display: flex; align-items: center; gap: 5px; }

  /* Telegram send bar */
  .tg-bar {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px;
    background: var(--parchment);
    border-top: 1px solid var(--border);
    border-radius: 0 0 10px 10px;
    flex-wrap: wrap;
  }

  .tg-bar-label {
    font-size: 12px; font-weight: 600; color: var(--brown);
    flex-shrink: 0;
  }

  .tg-count {
    display: flex; gap: 8px; flex: 1;
  }

  .tg-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 12px;
    font-size: 11px; font-weight: 700;
  }

  .tg-badge.urgent { background: #fde8e8; color: var(--red); }
  .tg-badge.soon   { background: #fef5e0; color: var(--gold); }

  .btn-tg {
    display: inline-flex; align-items: center; gap: 7px;
    padding: 9px 18px;
    background: #2b5278;
    color: #fff;
    border: none; border-radius: 7px;
    font-family: 'DM Sans'; font-size: 13px; font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-tg:hover { background: #3a6fa8; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(43,82,120,0.35); }
  .btn-tg svg { width: 16px; height: 16px; fill: currentColor; }

  .btn-tg-settings {
    background: transparent;
    border: 1.5px solid #c8d8e8;
    color: #6a90b0;
    padding: 8px 14px;
    border-radius: 7px;
    font-size: 12px; font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .btn-tg-settings:hover { background: #edf3f8; border-color: #2b5278; color: #2b5278; }

  /* Telegram settings modal */
  .tg-settings-box {
    background: #edf3f8;
    border: 1px solid #c8d8e8;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .tg-settings-box label { color: #3a6090; }
  .tg-settings-box input { background: #fff; border-color: #c8d8e8; }
  .tg-settings-box input:focus { border-color: #2b5278; box-shadow: 0 0 0 3px rgba(43,82,120,0.1); }

  /* Order preview in tg modal */
  .order-preview {
    background: #f5f5f5;
    border-radius: 8px;
    padding: 14px 16px;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 12px;
    line-height: 1.7;
    color: #333;
    max-height: 280px;
    overflow-y: auto;
    white-space: pre-wrap;
    border: 1px solid #ddd;
  }
</style>
<style>
  /* ===== PRINT BUTTON ===== */
  .btn-print {
    display: inline-flex; align-items: center;
    padding: 7px 16px;
    background: var(--parchment);
    border: 1.5px solid var(--border);
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px; font-weight: 600;
    color: var(--brown);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-print:hover { background: #ede4cc; border-color: var(--amber); color: var(--amber); }

  /* ===== PRINT AREA (hidden on screen) ===== */
  #print-area { display: none; }

  @media print {
    body * { visibility: hidden; }
    #print-area, #print-area * { visibility: visible; }
    #print-area {
      display: block !important;
      position: absolute; top: 0; left: 0;
      width: 100%;
      padding: 20px;
      font-family: 'DM Sans', Arial, sans-serif;
    }
    body { background: #fff !important; padding: 0 !important; }

    .print-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #333;
    }
    .print-logo { display: flex; align-items: center; gap: 10px; }
    .print-title { font-size: 22px; font-weight: 900; color: #1a1510; }
    .print-subtitle { font-size: 11px; color: #888; letter-spacing: 2px; text-transform: uppercase; margin-top: 2px; }
    .print-meta { font-size: 11px; color: #666; text-align: right; line-height: 1.8; }

    .print-zone-block { page-break-inside: avoid; margin-bottom: 16px; }
    .print-zone-title {
      font-size: 12px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 2px; color: #444;
      margin: 20px 0 6px;
      padding: 5px 8px;
      background: #f5f0e8;
      border-left: 3px solid #3d2b1a;
    }

    .print-table {
      width: 100%; border-collapse: collapse;
      font-size: 12px; margin-bottom: 4px;
    }
    .print-table th {
      padding: 7px 10px;
      text-align: left;
      font-weight: 700; font-size: 10px;
      text-transform: uppercase; letter-spacing: 1.5px; color: #555;
      border: 1px solid #bbb;
      background: #faf7f0;
    }
    .print-table td {
      padding: 9px 10px;
      border: 1px solid #ddd;
      vertical-align: middle;
    }
    .print-table tr:nth-child(even) td { background: #fdfaf4; }
    .print-table td.col-name { font-weight: 500; width: 45%; }
    .print-table td.col-qty { font-weight: 700; font-size: 13px; text-align: center; width: 20%; white-space: nowrap; }
    .print-table td.col-qty.low { color: #b8943a; }
    .print-table td.col-qty.empty { color: #c0392b; }
    .print-table th.col-note, .print-table td.col-note { width: 35%; background: #fff !important; }

    .print-footer {
      margin-top: 24px; padding-top: 8px;
      border-top: 1px solid #ccc;
      font-size: 10px; color: #aaa;
      display: flex; justify-content: space-between;
    }
  }
</style>
<body>

<header>
  <div class="logo">
    <div class="logo-emblem">üêë</div>
    <div class="logo-text">
      <h1>–ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</h1>
      <p>–ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ ¬∑ –†–µ—Å—Ç–æ—Ä–∞–Ω</p>
    </div>
  </div>
  <div class="header-right">
    <div id="sync-badge" style="display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:20px;background:rgba(255,255,255,0.06);">
      <span id="sync-dot" style="width:8px;height:8px;border-radius:50%;background:var(--gold-light);display:inline-block;flex-shrink:0;animation:blink-sync 1.5s infinite;transition:background 0.4s;"></span>
      <span id="sync-label" style="font-size:11px;font-weight:600;color:var(--gold-light);letter-spacing:1px;white-space:nowrap;">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</span>
    </div>
    <div>
      <div id="clock">--:--:--</div>
      <div id="date-disp" style="font-size:11px;color:var(--gold-light);text-align:right;margin-top:1px;"></div>
    </div>
  </div>
</header>
<style>@keyframes blink-sync{0%,100%{opacity:1}50%{opacity:0.4}}</style>

<div class="page">

  <div class="page-header">
    <div>
      <div class="page-title">–ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</div>
      <div class="page-subtitle">–ê–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∑–∞–ø–∞—Å—ñ–≤</div>
    </div>
    <button class="btn" style="width:auto;padding:10px 20px;" onclick="document.getElementById('add-modal').classList.add('open')">
      + –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç
    </button>
  </div>

  <!-- STATS -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">üì¶</div>
      <div class="stat-label">–í—Å—å–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–π</div>
      <div class="stat-val" id="s-total">0</div>
    </div>
    <div class="stat-card s-cold">
      <div class="stat-icon">üå°Ô∏è</div>
      <div class="stat-label">–ó–æ–Ω –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</div>
      <div class="stat-val" id="s-zones">0</div>
    </div>
    <div class="stat-card s-warn">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-label">–ú–∞–ª–∏–π –∑–∞–ø–∞—Å</div>
      <div class="stat-val" id="s-low">0</div>
    </div>
    <div class="stat-card s-danger">
      <div class="stat-icon">üö®</div>
      <div class="stat-label">–ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —Ç–µ—Ä–º—ñ–Ω</div>
      <div class="stat-val" id="s-expire">0</div>
    </div>
    <div class="stat-card s-danger">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-label">–í—ñ–¥—Å—É—Ç–Ω—ñ</div>
      <div class="stat-val" id="s-empty">0</div>
    </div>
  </div>

  <div class="layout">

    <!-- LEFT: ZONES overview -->
    <div>
      <button class="sidebar-toggle" id="sidebar-btn" onclick="toggleSidebar()">
        üó∫Ô∏è –ó–æ–Ω–∏ —Ç–∞ –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è
        <span class="arrow">‚ñº</span>
      </button>
      <div class="sidebar-collapsible" id="sidebar-content">
      <div class="card" style="margin-bottom:14px;">
        <div class="card-header"><span class="icon">üó∫Ô∏è</span><h2>–ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</h2></div>
        <div class="card-body" style="padding:14px;">
          <div id="zone-overview"></div>
        </div>
      </div>

      <!-- Quick adjust -->
      <div class="card">
        <div class="card-header"><span class="icon">‚ö°</span><h2>–®–≤–∏–¥–∫–µ –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è</h2></div>
        <div class="card-body">
          <div class="fg">
            <label>–ù–∞–∑–≤–∞ –∞–±–æ –∞—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥—É–∫—Ç—É</label>
            <input type="text" id="adj-q" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏..." oninput="suggestAdj()" autocomplete="off" />
            <div id="adj-suggestions" style="position:relative;"></div>
          </div>
          <div class="form-row">
            <div class="fg">
              <label>–û–ø–µ—Ä–∞—Ü—ñ—è</label>
              <select id="adj-op">
                <option value="add">‚ûï –ü—Ä–∏—Ö—ñ–¥</option>
                <option value="sub">‚ûñ –í–∏—Ç—Ä–∞—Ç–∞</option>
                <option value="set">üìã –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏</option>
              </select>
            </div>
            <div class="fg">
              <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
              <input type="number" id="adj-val" placeholder="0" min="0" />
            </div>
          </div>
          <button class="btn" onclick="doAdjust()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –∑–º—ñ–Ω—É</button>
        </div>
      </div>
      </div><!-- /sidebar-collapsible -->
    </div>

    <!-- RIGHT: TABLE -->
    <div class="card">
      <div class="card-header" style="justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span class="icon">üìã</span><h2>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤</h2>
        </div>
        <button class="btn-print" onclick="printTable()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px;vertical-align:-2px;margin-right:6px;"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"/></svg>
          –î—Ä—É–∫—É–≤–∞—Ç–∏
        </button>
      </div>
      <div class="card-body" style="padding-bottom:0;">

        <div class="search-bar">
          <span class="s-icon">üîç</span>
          <input type="text" id="search-inp" placeholder="–ü–æ—à—É–∫ –ø—Ä–æ–¥—É–∫—Ç—É, –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, –∞—Ä—Ç–∏–∫—É–ª—É..." oninput="renderTable()" />
        </div>

        <div class="zone-tabs" id="zone-tabs">
          <button class="ztab active" data-z="all" onclick="setZone(this)">–í—Å—ñ –∑–æ–Ω–∏</button>
          <button class="ztab" data-z="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–∞–≥–æ—Ç—ñ–≤–µ–ª—å–Ω–∏–π + –º–æ—Ä–æ–∑–∏–ª–∫–∞" onclick="setZone(this)">‚ùÑÔ∏è –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–∞–≥–æ—Ç—ñ–≤–µ–ª—å–Ω–∏–π + –º–æ—Ä–æ–∑–∏–ª–∫–∞</button>
          <button class="ztab" data-z="–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–µ–ª–µ–Ω—å" onclick="setZone(this)">üåø –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–µ–ª–µ–Ω—å</button>
          <button class="ztab" data-z="–°—É—Ö–∏–π —Å–∫–ª–∞–¥" onclick="setZone(this)">üì¶ –°—É—Ö–∏–π —Å–∫–ª–∞–¥</button>
        </div>

        <div class="filter-row">
          <span class="filter-label">–§–Ü–õ–¨–¢–†:</span>
          <button class="fpill expire" onclick="toggleFilter(this,'expire')" data-f="expire">üïê –¢–µ—Ä–º—ñ–Ω —Å–ø–ª–∏–≤–∞—î</button>
          <button class="fpill warn" onclick="toggleFilter(this,'low')" data-f="low">‚ö†Ô∏è –ú–∞–ª–∏–π –∑–∞–ø–∞—Å</button>
          <button class="fpill" onclick="toggleFilter(this,'empty')" data-f="empty">‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ</button>
        </div>

      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th onclick="sortBy('name')">–ü—Ä–æ–¥—É–∫—Ç ‚Üï</th>
              <th onclick="sortBy('zone')">–ó–æ–Ω–∞ ‚Üï</th>
              <th onclick="sortBy('qty')" style="text-align:right">–ö—ñ–ª—å–∫—ñ—Å—Ç—å ‚Üï</th>
              <th onclick="sortBy('expiry')">–¢–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç. ‚Üï</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th style="text-align:center">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
              <th style="text-align:center;min-width:80px">–ó–∞–º–æ–≤. –∫—ñ–ª—å–∫.</th>
              <th>–î—ñ—ó</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty-st" class="empty-state" style="display:none;">
          <div class="e-icon">ü•ó</div>
          <p>–ü—Ä–æ–¥—É–∫—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
        </div>
      </div>

      <!-- Telegram send bar -->
      <div class="tg-bar" id="tg-bar">
        <span class="tg-bar-label">üìã –î–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
        <div class="tg-count">
          <span class="tg-badge urgent" id="tg-urgent-count" style="display:none">üö® <span id="tg-uc">0</span> —Ç–µ—Ä–º—ñ–Ω–æ–≤–∏—Ö</span>
          <span class="tg-badge soon" id="tg-soon-count" style="display:none">‚ö†Ô∏è <span id="tg-sc">0</span> –Ω–∞–π–±–ª–∏–∂—á–∏—Ö</span>
          <span id="tg-none-label" style="font-size:12px;color:#aaa;">–ù–µ–º–∞—î –≤—ñ–¥–º—ñ—Ç–æ–∫</span>
        </div>
        <button class="btn-tg-settings" onclick="openTgSettings()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
        <button class="btn-tg" onclick="openTgSend()" id="btn-send-tg" disabled style="opacity:0.4;">
          <svg viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12l-6.871 4.326-2.962-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.833.941z"/></svg>
          –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤ Telegram
        </button>
      </div>
    </div>

  </div>
</div>

<!-- PRINT AREA -->
<div id="print-area"></div>

<!-- ADD MODAL -->
<div class="overlay" id="add-modal">
  <div class="modal">
    <div class="modal-head">
      <h3>‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç</h3>
    </div>
    <div class="modal-body">
      <div class="fg"><label>–ù–∞–∑–≤–∞ –ø—Ä–æ–¥—É–∫—Ç—É *</label><input type="text" id="a-name" placeholder="–Ω–∞–ø—Ä. –ö—É—Ä—è—á–µ —Ñ—ñ–ª–µ" /></div>
      <div class="form-row">
        <div class="fg"><label>–ê—Ä—Ç–∏–∫—É–ª</label><input type="text" id="a-sku" placeholder="–Ω–∞–ø—Ä. CHKN-FLT" /></div>
        <div class="fg"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
          <select id="a-cat">
            <option>–ú'—è—Å–æ —Ç–∞ –ø—Ç–∏—Ü—è</option><option>–†–∏–±–∞ —Ç–∞ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏</option>
            <option>–û–≤–æ—á—ñ —Ç–∞ —Ñ—Ä—É–∫—Ç–∏</option><option>–ú–æ–ª–æ—á–Ω—ñ –ø—Ä–æ–¥—É–∫—Ç–∏</option>
            <option>–Ø–π—Ü—è</option><option>–ö—Ä—É–ø–∏ —Ç–∞ –±–æ—Ä–æ—à–Ω–æ</option>
            <option>–ö–æ–Ω—Å–µ—Ä–≤–∏ —Ç–∞ —Å–æ—É—Å–∏</option><option>–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏</option>
            <option>–ê–ª–∫–æ–≥–æ–ª—å</option><option>–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ñ –Ω–∞–ø–æ—ó</option>
            <option>–•–ª—ñ–± —Ç–∞ –≤–∏–ø—ñ—á–∫–∞</option><option>–ó–∞–º–æ—Ä–æ–∂–µ–Ω—ñ –ø—Ä–æ–¥—É–∫—Ç–∏</option>
            <option>–û–ª—ñ—ó —Ç–∞ –∂–∏—Ä–∏</option><option>–Ü–Ω—à–µ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>–ó–æ–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è *</label>
          <select id="a-zone">
            <option>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–∞–≥–æ—Ç—ñ–≤–µ–ª—å–Ω–∏–π + –º–æ—Ä–æ–∑–∏–ª–∫–∞</option><option>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–µ–ª–µ–Ω—å</option>
            <option>–°—É—Ö–∏–π —Å–∫–ª–∞–¥</option>
          </select>
        </div>
        <div class="fg"><label>–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É</label>
          <select id="a-unit">
            <option value="–∫–≥">–∫–≥</option><option value="–≥">–≥</option>
            <option value="–ª">–ª</option><option value="–º–ª">–º–ª</option>
            <option value="—à—Ç">—à—Ç</option><option value="—É–ø–∞–∫">—É–ø–∞–∫</option>
            <option value="–ø–ª—è—à">–ø–ª—è—à</option><option value="–ø–∞—á">–ø–∞—á</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å *</label><input type="number" id="a-qty" placeholder="0" min="0" step="0.1" /></div>
        <div class="fg"><label>–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å</label><input type="number" id="a-min" placeholder="5" min="0" step="0.1" /></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>–¢–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ</label><input type="date" id="a-exp" /></div>
        <div class="fg"><label>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</label><input type="text" id="a-sup" placeholder="–Ω–∞–ø—Ä. –ê–¢–ë, Metro" /></div>
      </div>
      <div class="fg"><label>–ü—Ä–∏–º—ñ—Ç–∫–∞</label><input type="text" id="a-note" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è..." /></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModals()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn" onclick="addItem()">–î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-head"><h3>‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç</h3></div>
    <div class="modal-body">
      <input type="hidden" id="e-id" />
      <div class="fg"><label>–ù–∞–∑–≤–∞ –ø—Ä–æ–¥—É–∫—Ç—É</label><input type="text" id="e-name" /></div>
      <div class="form-row">
        <div class="fg"><label>–ê—Ä—Ç–∏–∫—É–ª</label><input type="text" id="e-sku" /></div>
        <div class="fg"><label>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
          <select id="e-cat">
            <option>–ú'—è—Å–æ —Ç–∞ –ø—Ç–∏—Ü—è</option><option>–†–∏–±–∞ —Ç–∞ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç–∏</option>
            <option>–û–≤–æ—á—ñ —Ç–∞ —Ñ—Ä—É–∫—Ç–∏</option><option>–ú–æ–ª–æ—á–Ω—ñ –ø—Ä–æ–¥—É–∫—Ç–∏</option>
            <option>–Ø–π—Ü—è</option><option>–ö—Ä—É–ø–∏ —Ç–∞ –±–æ—Ä–æ—à–Ω–æ</option>
            <option>–ö–æ–Ω—Å–µ—Ä–≤–∏ —Ç–∞ —Å–æ—É—Å–∏</option><option>–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏</option>
            <option>–ê–ª–∫–æ–≥–æ–ª—å</option><option>–ë–µ–∑–∞–ª–∫–æ–≥–æ–ª—å–Ω—ñ –Ω–∞–ø–æ—ó</option>
            <option>–•–ª—ñ–± —Ç–∞ –≤–∏–ø—ñ—á–∫–∞</option><option>–ó–∞–º–æ—Ä–æ–∂–µ–Ω—ñ –ø—Ä–æ–¥—É–∫—Ç–∏</option>
            <option>–û–ª—ñ—ó —Ç–∞ –∂–∏—Ä–∏</option><option>–Ü–Ω—à–µ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>–ó–æ–Ω–∞</label>
          <select id="e-zone">
            <option>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–∞–≥–æ—Ç—ñ–≤–µ–ª—å–Ω–∏–π + –º–æ—Ä–æ–∑–∏–ª–∫–∞</option><option>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–µ–ª–µ–Ω—å</option>
            <option>–°—É—Ö–∏–π —Å–∫–ª–∞–¥</option>
          </select>
        </div>
        <div class="fg"><label>–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É</label>
          <select id="e-unit">
            <option value="–∫–≥">–∫–≥</option><option value="–≥">–≥</option>
            <option value="–ª">–ª</option><option value="–º–ª">–º–ª</option>
            <option value="—à—Ç">—à—Ç</option><option value="—É–ø–∞–∫">—É–ø–∞–∫</option>
            <option value="–ø–ª—è—à">–ø–ª—è—à</option><option value="–ø–∞—á">–ø–∞—á</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="fg"><label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label><input type="number" id="e-qty" min="0" step="0.1" /></div>
        <div class="fg"><label>–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å</label><input type="number" id="e-min" min="0" step="0.1" /></div>
      </div>
      <div class="form-row">
        <div class="fg"><label>–¢–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ</label><input type="date" id="e-exp" /></div>
        <div class="fg"><label>–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫</label><input type="text" id="e-sup" /></div>
      </div>
      <div class="fg"><label>–ü—Ä–∏–º—ñ—Ç–∫–∞</label><input type="text" id="e-note" /></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModals()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn" onclick="saveEdit()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<!-- TELEGRAM SETTINGS MODAL -->
<div class="overlay" id="tg-settings-modal">
  <div class="modal">
    <div class="modal-head" style="background:#edf3f8;border-bottom:1px solid #c8d8e8;">
      <h3 style="color:#2b5278;">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram</h3>
      <p style="font-size:12px;color:#6a90b0;margin-top:4px;">–ë–æ—Ç –Ω–∞–¥—Å–∏–ª–∞—Ç–∏–º–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É –≤–∫–∞–∑–∞–Ω–∏–π —á–∞—Ç/–≥—Ä—É–ø—É</p>
    </div>
    <div class="modal-body">
      <div class="tg-settings-box">
        <div class="fg">
          <label>Bot Token</label>
          <input type="text" id="tg-token" placeholder="1234567890:ABCdefGHIjklMNOpqrSTUvwxYZ" />
          <div style="font-size:10px;color:#aaa;margin-top:4px;">–û—Ç—Ä–∏–º–∞–π—Ç–µ —É @BotFather ‚Üí /newbot</div>
        </div>
        <div class="fg" style="margin-bottom:0;">
          <label>Chat ID</label>
          <input type="text" id="tg-chatid" placeholder="-1001234567890 –∞–±–æ @–Ω–∞–∑–≤–∞_–≥—Ä—É–ø–∏" />
          <div style="font-size:10px;color:#aaa;margin-top:4px;">–î–æ–¥–∞–π—Ç–µ –±–æ—Ç–∞ –¥–æ —á–∞—Ç—É/–≥—Ä—É–ø–∏. ID –º–æ–∂–Ω–∞ –¥—ñ–∑–Ω–∞—Ç–∏—Å—å —á–µ—Ä–µ–∑ @userinfobot</div>
        </div>
      </div>
      <div id="tg-test-result" style="display:none;padding:10px 14px;border-radius:6px;font-size:12px;font-weight:600;margin-bottom:12px;"></div>
    </div>
    <div class="modal-foot" style="flex-wrap:wrap;gap:8px;">
      <button class="btn btn-ghost" onclick="closeModals()">–ó–∞–∫—Ä–∏—Ç–∏</button>
      <button class="btn" style="background:#6a90b0;" onclick="testTelegram()">üîó –¢–µ—Å—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è</button>
      <button class="btn" style="background:#2b5278;" onclick="saveTgSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<!-- TELEGRAM SEND MODAL -->
<div class="overlay" id="tg-send-modal">
  <div class="modal" style="width:560px;">
    <div class="modal-head" style="background:#edf3f8;border-bottom:1px solid #c8d8e8;">
      <h3 style="color:#2b5278;">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ Telegram</h3>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
        <span class="tg-badge urgent" id="tg-modal-urgent" style="font-size:12px;padding:5px 12px;"></span>
        <span class="tg-badge soon" id="tg-modal-soon" style="font-size:12px;padding:5px 12px;"></span>
      </div>
      <div style="font-size:11px;font-weight:600;color:#888;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</div>
      <div class="order-preview" id="tg-preview"></div>
      <div id="tg-send-result" style="display:none;padding:10px 14px;border-radius:6px;font-size:13px;font-weight:600;margin-top:12px;"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModals()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn" style="background:#2b5278;" onclick="sendToTelegram()" id="btn-do-send">
        <svg style="width:15px;height:15px;fill:currentColor;vertical-align:-2px;" viewBox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12l-6.871 4.326-2.962-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.833.941z"/></svg>
        –ù–∞–¥—ñ—Å–ª–∞—Ç–∏
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
import { getDatabase, ref, set, remove, onValue, push, update } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyA7hBzF8zx84X1kXcfTDvaWKWZBFQ-U0gk",
  authDomain: "baranchik-checklist.firebaseapp.com",
  databaseURL: "https://baranchik-checklist-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "baranchik-checklist",
  storageBucket: "baranchik-checklist.firebasestorage.app",
  messagingSenderId: "374378353806",
  appId: "1:374378353806:web:d3cdfca5e89fc80eece5df",
  measurementId: "G-GW64E8FBC8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const itemsRef = ref(db, 'storage/items');
const settingsRef = ref(db, 'storage/settings');

// ===== STATE =====
let items = [];
let curZone = 'all';
let sortF = 'name', sortD = 1;
let activeFilters = new Set();
let adjTarget = null;
let isLoaded = false;

// Order flags stored locally (per-session workflow)
let orderFlags = JSON.parse(localStorage.getItem('order_flags') || '{}');

// Telegram settings ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ Firebase
let tgToken = '';
let tgChatId = '';

// –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram –∑ Firebase –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
onValue(settingsRef, (snap) => {
  const s = snap.val();
  if (s) {
    tgToken  = s.tgToken  || '';
    tgChatId = s.tgChatId || '';
  }
}, { onlyOnce: true });

const ZONES = {
  '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–∞–≥–æ—Ç—ñ–≤–µ–ª—å–Ω–∏–π + –º–æ—Ä–æ–∑–∏–ª–∫–∞': { icon: '‚ùÑÔ∏è', cls: 'z-cold', temp: '+2¬∞C –¥–æ +6¬∞C' },
  '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∑–µ–ª–µ–Ω—å': { icon: 'üåø', cls: 'z-freeze', temp: '-18¬∞C' },
  '–°—É—Ö–∏–π —Å–∫–ª–∞–¥': { icon: 'üì¶', cls: 'z-dry', temp: '+15¬∞C –¥–æ +20¬∞C' },
};

// ===== SYNC STATUS =====
function setStatus(state) {
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-label');
  if (!dot) return;
  const map = {
    online:      { bg: '#5a7a5c', text: '‚óè –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ' },
    connecting:  { bg: '#b8943a', text: '‚óå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...' },
    offline:     { bg: '#c0392b', text: '‚úï –ù–µ–º–∞—î –∑\'—î–¥–Ω–∞–Ω–Ω—è' },
  };
  const s = map[state] || map.offline;
  dot.style.background = s.bg;
  label.textContent = s.text;
}

// ===== CLOCK =====
function tick() {
  const n = new Date();
  document.getElementById('clock').textContent = n.toLocaleTimeString('uk-UA');
  document.getElementById('date-disp').textContent = n.toLocaleDateString('uk-UA', { weekday: 'long', day: '2-digit', month: 'long' });
}
setInterval(tick, 1000); tick();

// ===== EXPIRY =====
function daysLeft(expStr) {
  if (!expStr) return null;
  return Math.ceil((new Date(expStr) - new Date()) / 86400000);
}
function expiryStatus(expStr) {
  const d = daysLeft(expStr);
  if (d === null) return null;
  if (d < 0) return 'expired';
  if (d <= 3) return 'soon';
  return 'ok';
}

// ===== FIREBASE LISTENER =====
setStatus('connecting');
onValue(itemsRef, (snapshot) => {
  const data = snapshot.val();
  items = data ? Object.entries(data).map(([fbKey, val]) => ({ ...val, fbKey })) : [];
  if (!isLoaded && items.length === 0) seedSampleData();
  isLoaded = true;
  setStatus('online');
  renderAll();
}, () => setStatus('offline'));

// ===== SEED SAMPLE DATA =====
function seedSampleData() {
  const today = new Date().toLocaleDateString('uk-UA');
  const samples = [
    { name: '–ë–∞—Ä–±–∞—Ä–∏—Å –≤\'—è–ª–µ–Ω–∏–π',          category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 2,    minQty: 1,   expiry: '2026-03-31', supplier: '', note: '', addedAt: today },
    { name: '–í–µ–≥–µ—Ç–∞',                       category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 0.5, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ó—ñ—Ä–∞',                         category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ö–º–∏–Ω',                         category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ö–æ—Ä—ñ–∞–Ω–¥—Ä',                     category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 2,    minQty: 1,   expiry: '2026-03-31', supplier: '', note: '', addedAt: today },
    { name: '–ö—É–Ω–∂—É—Ç',                       category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.5,  minQty: 0.5, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–û—Ü–µ—Ç —Å—Ç–æ–ª–æ–≤–∏–π',                category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 5,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ü–∞–∂–∏—Ç–Ω–∏–∫',                     category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.7,  minQty: 0.5, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ü–∞–ø—Ä–∏–∫–∞ –∫–∞–ø—á–µ–Ω—ñ',              category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ü–µ—Ä–µ—Ü—å –±–æ–ª–≥–∞—Ä—Å—å–∫–∏–π —Å—É—à–µ–Ω–∏–π',   category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ü–µ—Ä–µ—Ü—å –¥—É—Ö–º—è–Ω–∏–π –≥–æ—Ä–æ—à–æ–∫',      category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.2,  minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ü–µ—Ä–µ—Ü—å —á–æ—Ä–Ω–∏–π –º–µ–ª–µ–Ω–∏–π',        category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ü–ª–∞—Å—Ç—ñ–≤—Ü—ñ –ß—ñ–ª—ñ',               category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–°–≤–∞–Ω—Å—å–∫–∞ —Å—ñ–ª—å',                category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–°–æ—É—Å –≤–æ—Ä—á–µ—Å—Ç–µ—Ä',               category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1.5,  minQty: 0.5, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–°–æ—É—Å —Å–æ—î–≤–∏–π',                  category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 2,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–°–ø–µ—Ü—ñ—è –¥–ª—è —Ä–∏–±–∏',              category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0,    minQty: 0.2, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–°—É–º–∞—Ö',                        category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 2,    minQty: 0.5, expiry: '2026-03-31', supplier: '', note: '', addedAt: today },
    { name: '–°—É–º—ñ—à –ø–µ—Ä—Ü—ñ–≤',                 category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.5,  minQty: 0.5, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–¢–æ–º–∞—Ç —Å—É—à–µ–Ω–∏–π',                category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–£—Ü—Ö–æ',                         category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.5,  minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–•–º–µ–ª—ñ',                        category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 2,    minQty: 1,   expiry: '2026-03-31', supplier: '', note: '', addedAt: today },
    { name: '–ß–∞—Å–Ω–∏–∫ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ',             category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ß–∞—Å–Ω–∏–∫ —Å—É—à–µ–Ω–∏–π –≥—Ä–∞–Ω—É–ª–∏',       category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.5,  minQty: 0.5, expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–ß–µ–±—Ä–µ—Ü—å —Å—É—à–µ–Ω–∏–π',              category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 1,    minQty: 1,   expiry: '',           supplier: '', note: '', addedAt: today },
    { name: '–®–∞—Ñ—Ä–∞–Ω',                       category: '–°–ø–µ—Ü—ñ—ó —Ç–∞ –ø—Ä–∏–ø—Ä–∞–≤–∏', zone: '–°—É—Ö–∏–π —Å–∫–ª–∞–¥', unit: '–∫–≥', qty: 0.15, minQty: 0.1, expiry: '',           supplier: '', note: '', addedAt: today },
  ];
  samples.forEach(item => push(itemsRef, item));
}

// ===== ORDER FLAGS =====
function saveFlags() { localStorage.setItem('order_flags', JSON.stringify(orderFlags)); }

window.toggleFlag = function(fbKey, type) {
  if (!orderFlags[fbKey]) orderFlags[fbKey] = { flag: null, orderQty: '' };
  const current = orderFlags[fbKey].flag;
  // Toggle: same flag ‚Üí off, different ‚Üí switch
  orderFlags[fbKey].flag = (current === type) ? null : type;
  saveFlags();
  renderAll();
};

window.setOrderQty = function(fbKey, val) {
  if (!orderFlags[fbKey]) orderFlags[fbKey] = { flag: null, orderQty: '' };
  orderFlags[fbKey].orderQty = val;
  saveFlags();
  updateTgBar();
};

function getFlaggedItems() {
  return items
    .filter(it => orderFlags[it.fbKey] && orderFlags[it.fbKey].flag)
    .map(it => ({ ...it, flag: orderFlags[it.fbKey].flag, orderQty: orderFlags[it.fbKey].orderQty || '' }));
}

function updateTgBar() {
  const flagged = getFlaggedItems();
  const urgent = flagged.filter(i => i.flag === 'urgent');
  const soon = flagged.filter(i => i.flag === 'soon');

  const ucEl = document.getElementById('tg-uc');
  const scEl = document.getElementById('tg-sc');
  const ubadge = document.getElementById('tg-urgent-count');
  const sbadge = document.getElementById('tg-soon-count');
  const noneLabel = document.getElementById('tg-none-label');
  const sendBtn = document.getElementById('btn-send-tg');

  if (ucEl) ucEl.textContent = urgent.length;
  if (scEl) scEl.textContent = soon.length;
  if (ubadge) ubadge.style.display = urgent.length ? 'inline-flex' : 'none';
  if (sbadge) sbadge.style.display = soon.length ? 'inline-flex' : 'none';
  if (noneLabel) noneLabel.style.display = flagged.length ? 'none' : 'inline';
  if (sendBtn) { sendBtn.disabled = flagged.length === 0; sendBtn.style.opacity = flagged.length ? '1' : '0.4'; }
}

// ===== ADD / DELETE / EDIT / ADJUST =====
window.addItem = function() {
  const name = document.getElementById('a-name').value.trim();
  const qty = parseFloat(document.getElementById('a-qty').value);
  if (!name) { showToast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø—Ä–æ–¥—É–∫—Ç—É!', 'err'); return; }
  if (isNaN(qty)) { showToast('–í–≤–µ–¥—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å!', 'err'); return; }
  const newItem = {
    name, sku: document.getElementById('a-sku').value.trim() || '',
    category: document.getElementById('a-cat').value,
    zone: document.getElementById('a-zone').value,
    unit: document.getElementById('a-unit').value, qty,
    minQty: parseFloat(document.getElementById('a-min').value) || 0,
    expiry: document.getElementById('a-exp').value || '',
    supplier: document.getElementById('a-sup').value.trim() || '',
    note: document.getElementById('a-note').value.trim() || '',
    addedAt: new Date().toLocaleDateString('uk-UA')
  };
  push(itemsRef, newItem)
    .then(() => { closeModals(); showToast(`‚úì "${name}" –¥–æ–¥–∞–Ω–æ –¥–æ ${newItem.zone}`, 'ok'); ['a-name','a-sku','a-qty','a-min','a-exp','a-sup','a-note'].forEach(id => document.getElementById(id).value = ''); })
    .catch(e => showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'err'));
};

window.deleteItem = function(fbKey) {
  const it = items.find(i => i.fbKey === fbKey);
  if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${it.name}" –∑—ñ —Å–ø–∏—Å–∫—É?`)) return;
  delete orderFlags[fbKey]; saveFlags();
  remove(ref(db, 'storage/items/' + fbKey))
    .then(() => showToast(`–í–∏–¥–∞–ª–µ–Ω–æ: ${it.name}`))
    .catch(e => showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'err'));
};

window.openEdit = function(fbKey) {
  const it = items.find(i => i.fbKey === fbKey);
  document.getElementById('e-id').value = fbKey;
  document.getElementById('e-name').value = it.name;
  document.getElementById('e-sku').value = it.sku || '';
  document.getElementById('e-cat').value = it.category;
  document.getElementById('e-zone').value = it.zone;
  document.getElementById('e-unit').value = it.unit;
  document.getElementById('e-qty').value = it.qty;
  document.getElementById('e-min').value = it.minQty;
  document.getElementById('e-exp').value = it.expiry || '';
  document.getElementById('e-sup').value = it.supplier || '';
  document.getElementById('e-note').value = it.note || '';
  document.getElementById('edit-modal').classList.add('open');
};

window.saveEdit = function() {
  const fbKey = document.getElementById('e-id').value;
  const it = items.find(i => i.fbKey === fbKey);
  const updated = {
    name: document.getElementById('e-name').value.trim() || it.name,
    sku: document.getElementById('e-sku').value.trim(),
    category: document.getElementById('e-cat').value,
    zone: document.getElementById('e-zone').value,
    unit: document.getElementById('e-unit').value,
    qty: parseFloat(document.getElementById('e-qty').value) || 0,
    minQty: parseFloat(document.getElementById('e-min').value) || 0,
    expiry: document.getElementById('e-exp').value || '',
    supplier: document.getElementById('e-sup').value.trim(),
    note: document.getElementById('e-note').value.trim(),
    addedAt: it.addedAt
  };
  update(ref(db, 'storage/items/' + fbKey), updated)
    .then(() => { closeModals(); showToast(`‚úì "${updated.name}" –æ–Ω–æ–≤–ª–µ–Ω–æ`, 'ok'); })
    .catch(e => showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'err'));
};

window.suggestAdj = function() {
  const q = document.getElementById('adj-q').value.toLowerCase().trim();
  const box = document.getElementById('adj-suggestions');
  if (!q) { box.innerHTML = ''; adjTarget = null; return; }
  const matches = items.filter(i => i.name.toLowerCase().includes(q) || (i.sku||'').toLowerCase().includes(q)).slice(0,5);
  if (!matches.length) { box.innerHTML = ''; return; }
  box.innerHTML = `<div style="position:absolute;top:0;left:0;right:0;background:var(--warm-white);border:1px solid var(--border);border-radius:6px;z-index:50;box-shadow:var(--shadow);">${
    matches.map(it => `<div onclick="selectAdj('${it.fbKey}')" style="padding:8px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border);transition:background 0.1s;" onmouseover="this.style.background='var(--parchment)'" onmouseout="this.style.background=''">${it.name} <span style="color:#aaa;font-size:11px;">(${it.qty} ${it.unit}) ¬∑ ${it.zone}</span></div>`).join('')
  }</div>`;
};
window.selectAdj = function(fbKey) {
  adjTarget = fbKey; const it = items.find(i => i.fbKey === fbKey);
  document.getElementById('adj-q').value = it.name; document.getElementById('adj-suggestions').innerHTML = '';
};
window.doAdjust = function() {
  if (!adjTarget) { showToast('–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–¥—É–∫—Ç –∑—ñ —Å–ø–∏—Å–∫—É!', 'err'); return; }
  const val = parseFloat(document.getElementById('adj-val').value);
  if (isNaN(val) || val < 0) { showToast('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å!', 'err'); return; }
  const op = document.getElementById('adj-op').value;
  const it = items.find(i => i.fbKey === adjTarget);
  const old = it.qty;
  let newQty = op === 'add' ? Math.round((it.qty+val)*100)/100 : op === 'sub' ? Math.max(0, Math.round((it.qty-val)*100)/100) : val;
  update(ref(db, 'storage/items/' + adjTarget), { qty: newQty })
    .then(() => { const lbl = op==='add'?'–ø—Ä–∏—Ö–æ–¥':op==='sub'?'–≤–∏—Ç—Ä–∞—Ç–∞':'–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'; showToast(`‚úì ${it.name}: ${old} ‚Üí ${newQty} ${it.unit} (${lbl})`, 'ok'); document.getElementById('adj-q').value=''; document.getElementById('adj-val').value=''; adjTarget=null; })
    .catch(e => showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'err'));
};

// ===== FILTERS =====
window.setZone = function(el) { document.querySelectorAll('.ztab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); curZone=el.dataset.z; renderTable(); };
window.toggleFilter = function(el,f) { if(activeFilters.has(f)){activeFilters.delete(f);el.classList.remove('active');}else{activeFilters.add(f);el.classList.add('active');} renderTable(); };
window.sortBy = function(f) { if(sortF===f)sortD*=-1;else{sortF=f;sortD=1;} renderTable(); };
window.filterByZone = function(zname) { curZone=zname; document.querySelectorAll('.ztab').forEach(t=>t.classList.toggle('active',t.dataset.z===zname)); renderTable(); };

// ===== RENDER TABLE =====
function renderTable() {
  const q = document.getElementById('search-inp').value.toLowerCase();
  let list = items.filter(it => {
    if (curZone !== 'all' && it.zone !== curZone) return false;
    if (q && !it.name.toLowerCase().includes(q) && !(it.category||'').toLowerCase().includes(q) && !(it.sku||'').toLowerCase().includes(q)) return false;
    if (activeFilters.has('empty') && it.qty > 0) return false;
    if (activeFilters.has('low') && (it.qty===0||it.minQty===0||it.qty>=it.minQty)) return false;
    if (activeFilters.has('expire')) { const es=expiryStatus(it.expiry); if(es!=='soon'&&es!=='expired') return false; }
    return true;
  });
  list.sort((a,b) => {
    let av=a[sortF],bv=b[sortF];
    if(sortF==='expiry'){av=av?new Date(av).getTime():Infinity;bv=bv?new Date(bv).getTime():Infinity;}
    else if(typeof av==='string'){av=av.toLowerCase();bv=bv.toLowerCase();}
    return av>bv?sortD:av<bv?-sortD:0;
  });

  const tbody = document.getElementById('tbody');
  const empty = document.getElementById('empty-st');
  if (!list.length) { tbody.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display = 'none';

  tbody.innerHTML = list.map(it => {
    const z = ZONES[it.zone] || { icon:'üì¶', cls:'z-dry' };
    const pct = it.minQty>0 ? Math.min(100,(it.qty/it.minQty)*100) : 100;
    let qtyClass='qty-num', sbClass='sb-ok', sbText='–í –ù–ê–Ø–í–ù–û–°–¢–Ü', dotCls='dot-ok';
    const es = expiryStatus(it.expiry);
    if (it.qty===0) { qtyClass='qty-num empty'; sbClass='sb-empty'; sbText='–í–Ü–î–°–£–¢–ù–Ü–ô'; dotCls='dot-empty'; }
    else if (it.minQty>0&&it.qty<it.minQty) { qtyClass='qty-num low'; sbClass='sb-low'; sbText='–ú–ê–õ–ò–ô –ó–ê–ü–ê–°'; dotCls='dot-low'; }
    if (es==='expired'&&it.qty>0) { sbClass='sb-expire'; sbText='–ü–†–û–°–¢–†–û–ß–ï–ù–û'; dotCls='dot-expire'; }
    else if (es==='soon'&&it.qty>0&&sbClass==='sb-ok') { sbClass='sb-expire'; sbText='–¢–ï–†–ú–Ü–ù –°–ü–õ–ò–í–ê–Ñ'; dotCls='dot-expire'; }
    const barColor = it.qty===0?'#e74c3c':pct<50?'#b8943a':'#5a7a5c';

    let expiryHtml = '<span class="exp-none">‚Äî</span>';
    if (it.expiry) {
      const d=daysLeft(it.expiry), dateStr=new Date(it.expiry).toLocaleDateString('uk-UA');
      if (d<0) expiryHtml=`<span class="exp-expired">‚ö† ${dateStr}<span class="exp-days">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ ${Math.abs(d)} –¥–Ω. —Ç–æ–º—É</span></span>`;
      else if (d<=3) expiryHtml=`<span class="exp-soon">‚è∞ ${dateStr}<span class="exp-days">–ó–∞–ª–∏—à–∏–ª–æ—Å—å: ${d} –¥–Ω.</span></span>`;
      else expiryHtml=`<span class="exp-ok">${dateStr}<span class="exp-days" style="color:#aaa;font-weight:400">–©–µ ${d} –¥–Ω.</span></span>`;
    }

    // Order flags
    const fData = orderFlags[it.fbKey] || { flag: null, orderQty: '' };
    const isSoon = fData.flag === 'soon';
    const isUrgent = fData.flag === 'urgent';
    const hasQty = fData.orderQty && fData.orderQty !== '';
    const key = it.fbKey;

    // Row highlight
    let rowStyle = '';
    if (isUrgent) rowStyle = 'background:rgba(192,57,43,0.04);';
    else if (isSoon) rowStyle = 'background:rgba(184,148,58,0.04);';

    return `<tr style="${rowStyle}">
      <td>
        <span class="prod-name">${it.name}</span>
        <span class="prod-cat">${it.category||''}${it.sku?' ¬∑ '+it.sku:''}${it.note?' ¬∑ '+it.note:''}</span>
      </td>
      <td><span class="zbadge ${z.cls}">${z.icon} ${it.zone}</span></td>
      <td class="qty-wrap">
        <div class="${qtyClass}">${it.qty} <span style="font-size:11px;font-weight:400;color:#aaa;">${it.unit}</span></div>
        ${it.minQty>0?`<div class="qty-bar"><div class="qty-bar-fill" style="width:${pct}%;background:${barColor};"></div></div><div style="font-size:10px;color:#aaa;margin-top:2px;">–º—ñ–Ω: ${it.minQty} ${it.unit}</div>`:''}
      </td>
      <td class="expiry-cell">${expiryHtml}</td>
      <td><span class="sbadge ${sbClass}"><span class="dot ${dotCls}"></span>${sbText}</span></td>
      <td class="order-col">
        <div class="flags-wrap" style="justify-content:center;">
          <button class="flag-btn ${isSoon?'soon-active':''}" onclick="toggleFlag('${key}','soon')" title="–ó–∞–º–æ–≤–∏—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º">‚ö†Ô∏è</button>
          <button class="flag-btn ${isUrgent?'urgent-active':''}" onclick="toggleFlag('${key}','urgent')" title="–ó–∞–º–æ–≤–∏—Ç–∏ –¢–ï–†–ú–Ü–ù–û–í–û">üö®</button>
        </div>
      </td>
      <td class="order-col">
        <input
          class="order-qty-inp ${hasQty?'has-val':''}"
          type="number" min="0" step="0.1"
          value="${fData.orderQty||''}"
          placeholder="‚Äî"
          oninput="setOrderQty('${key}', this.value)"
          title="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
        />
        ${fData.orderQty ? `<div style="font-size:10px;color:#888;margin-top:2px;">${it.unit}</div>` : ''}
      </td>
      <td class="row-actions">
        <button class="btn btn-outline-gold btn-sm" onclick="openEdit('${key}')">–†–µ–¥.</button>
        <button class="btn btn-outline-red btn-sm" onclick="deleteItem('${key}')">‚úï</button>
      </td>
    </tr>`;
  }).join('');

  updateTgBar();
}

// ===== ZONE OVERVIEW =====
function renderZoneOverview() {
  const box = document.getElementById('zone-overview');
  box.innerHTML = Object.entries(ZONES).map(([zname, zmeta]) => {
    const zItems = items.filter(i => i.zone===zname);
    const low = zItems.filter(i=>i.minQty>0&&i.qty<i.minQty&&i.qty>0).length;
    const empty = zItems.filter(i=>i.qty===0).length;
    const expiring = zItems.filter(i=>{const es=expiryStatus(i.expiry);return es==='soon'||es==='expired';}).length;
    const toOrder = zItems.filter(i=>orderFlags[i.fbKey]&&orderFlags[i.fbKey].flag).length;
    const zkey = encodeURIComponent(zname);
    return `<div style="margin-bottom:6px;">
      <div onclick="filterByZone('${zname}')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px 8px 0 0;cursor:pointer;transition:background 0.15s;background:var(--warm-white);border:1px solid var(--border);border-bottom:none;" onmouseover="this.style.background='var(--parchment)'" onmouseout="this.style.background='var(--warm-white)'">
        <span style="font-size:22px;">${zmeta.icon}</span>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:600;font-size:13px;color:var(--brown);">${zname}</div>
          <div style="font-size:10px;color:#aaa;">${zmeta.temp}</div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--ink);">${zItems.length}</div>
          <div style="font-size:10px;color:#aaa;">–ø–æ–∑–∏—Ü—ñ–π</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:2px;margin-left:4px;">
          ${toOrder?`<span style="background:#fde8e8;color:#c0391a;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700;">üìã ${toOrder}</span>`:''}
          ${low?`<span style="background:#fef5e0;color:var(--gold);padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700;">‚ö† ${low}</span>`:''}
          ${empty?`<span style="background:#fde8e8;color:var(--red);padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700;">‚úï ${empty}</span>`:''}
          ${expiring?`<span style="background:#fde8cc;color:#c0601a;padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700;">‚è∞ ${expiring}</span>`:''}
        </div>
      </div>
      <button onclick="event.stopPropagation();printZone('${zname}')" style="width:100%;display:flex;align-items:center;justify-content:center;gap:7px;padding:7px 12px;background:var(--parchment);border:1px solid var(--border);border-top:1px dashed var(--border);border-radius:0 0 8px 8px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--brown);cursor:pointer;transition:all 0.15s;" onmouseover="this.style.background='#ede4cc';this.style.color='var(--amber)'" onmouseout="this.style.background='var(--parchment)';this.style.color='var(--brown)'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;flex-shrink:0;"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"/></svg>
        –î—Ä—É–∫—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –∑–æ–Ω–∏
      </button>
    </div>`;
  }).join('');
}

// ===== STATS =====
function updateStats() {
  document.getElementById('s-total').textContent = items.length;
  document.getElementById('s-zones').textContent = new Set(items.map(i=>i.zone)).size;
  document.getElementById('s-low').textContent = items.filter(i=>i.minQty>0&&i.qty>0&&i.qty<i.minQty).length;
  document.getElementById('s-expire').textContent = items.filter(i=>{const es=expiryStatus(i.expiry);return es==='soon'||es==='expired';}).length;
  document.getElementById('s-empty').textContent = items.filter(i=>i.qty===0).length;
}

function renderAll() { renderTable(); renderZoneOverview(); updateStats(); }

// ===== TELEGRAM =====
window.openTgSettings = function() {
  document.getElementById('tg-token').value = tgToken;
  document.getElementById('tg-chatid').value = tgChatId;
  document.getElementById('tg-test-result').style.display = 'none';
  document.getElementById('tg-settings-modal').classList.add('open');
};

window.saveTgSettings = function() {
  tgToken  = document.getElementById('tg-token').value.trim();
  tgChatId = document.getElementById('tg-chatid').value.trim();
  set(settingsRef, { tgToken, tgChatId })
    .then(() => { closeModals(); showToast('‚úì –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram –∑–±–µ—Ä–µ–∂–µ–Ω–æ —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ', 'ok'); })
    .catch(e => showToast('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + e.message, 'err'));
};

window.testTelegram = async function() {
  const token = document.getElementById('tg-token').value.trim();
  const chatId = document.getElementById('tg-chatid').value.trim();
  const resBox = document.getElementById('tg-test-result');
  if (!token || !chatId) { resBox.style.display='block'; resBox.style.background='#fde8e8'; resBox.style.color='var(--red)'; resBox.textContent='–ó–∞–ø–æ–≤–Ω—ñ—Ç—å Token —ñ Chat ID'; return; }
  resBox.style.display='block'; resBox.style.background='#fef5e0'; resBox.style.color='var(--gold)'; resBox.textContent='–ù–∞–¥—Å–∏–ª–∞—î–º–æ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...';
  try {
    const r = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: chatId, text: 'üêë –ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ‚Äî —Ç–µ—Å—Ç–æ–≤–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ! ‚úÖ', parse_mode:'HTML' })
    });
    const data = await r.json();
    if (data.ok) { resBox.style.background='#e8f5e8'; resBox.style.color='var(--sage)'; resBox.textContent='‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!'; }
    else { resBox.style.background='#fde8e8'; resBox.style.color='var(--red)'; resBox.textContent='‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (data.description||'–Ω–µ–≤—ñ–¥–æ–º–∞'); }
  } catch(e) { resBox.style.background='#fde8e8'; resBox.style.color='var(--red)'; resBox.textContent='‚ùå –ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞: ' + e.message; }
};

function buildOrderMessage() {
  const flagged = getFlaggedItems();
  const urgent = flagged.filter(i=>i.flag==='urgent');
  const soon = flagged.filter(i=>i.flag==='soon');
  const now = new Date().toLocaleString('uk-UA',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});

  let msg = `üêë <b>–ó–ê–ú–û–í–õ–ï–ù–ù–Ø –ü–†–û–î–£–ö–¢–Ü–í</b>\nüìÖ ${now}\n`;
  msg += `${'‚îÄ'.repeat(28)}\n`;

  if (urgent.length) {
    msg += `\nüö® <b>–¢–ï–†–ú–Ü–ù–û–í–û –ó–ê–ú–û–í–ò–¢–ò:</b>\n`;
    const byZone = {};
    urgent.forEach(it => { if(!byZone[it.zone]) byZone[it.zone]=[]; byZone[it.zone].push(it); });
    Object.entries(byZone).forEach(([zone, zItems]) => {
      msg += `\n  ${ZONES[zone]?.icon||'üì¶'} <i>${zone}</i>\n`;
      zItems.forEach(it => {
        const qtyStr = it.orderQty ? ` ‚Üí –∑–∞–º–æ–≤–∏—Ç–∏: <b>${it.orderQty} ${it.unit}</b>` : '';
        const stockStr = ` (—î: ${it.qty} ${it.unit})`;
        msg += `  ‚Ä¢ ${it.name}${stockStr}${qtyStr}\n`;
      });
    });
  }

  if (soon.length) {
    msg += `\n‚ö†Ô∏è <b>–ù–ê–ô–ë–õ–ò–ñ–ß–ò–ú –ß–ê–°–û–ú:</b>\n`;
    const byZone = {};
    soon.forEach(it => { if(!byZone[it.zone]) byZone[it.zone]=[]; byZone[it.zone].push(it); });
    Object.entries(byZone).forEach(([zone, zItems]) => {
      msg += `\n  ${ZONES[zone]?.icon||'üì¶'} <i>${zone}</i>\n`;
      zItems.forEach(it => {
        const qtyStr = it.orderQty ? ` ‚Üí –∑–∞–º–æ–≤–∏—Ç–∏: <b>${it.orderQty} ${it.unit}</b>` : '';
        const stockStr = ` (—î: ${it.qty} ${it.unit})`;
        msg += `  ‚Ä¢ ${it.name}${stockStr}${qtyStr}\n`;
      });
    });
  }

  msg += `\n${'‚îÄ'.repeat(28)}\n`;
  msg += `üì¶ –í—Å—å–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–π: ${flagged.length} (üö® ${urgent.length} —Ç–µ—Ä–º—ñ–Ω., ‚ö†Ô∏è ${soon.length} –Ω–∞–π–±–ª–∏–∂—á.)`;
  return msg;
}

window.openTgSend = function() {
  if (!tgToken || !tgChatId) {
    showToast('–°–ø–æ—á–∞—Ç–∫—É –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ Telegram-–±–æ—Ç!', 'err');
    openTgSettings();
    return;
  }
  const flagged = getFlaggedItems();
  const urgent = flagged.filter(i=>i.flag==='urgent');
  const soon = flagged.filter(i=>i.flag==='soon');
  document.getElementById('tg-modal-urgent').textContent = `üö® ${urgent.length} —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ`;
  document.getElementById('tg-modal-soon').textContent = `‚ö†Ô∏è ${soon.length} –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º`;
  // Strip HTML tags for preview
  const previewText = buildOrderMessage().replace(/<[^>]+>/g,'');
  document.getElementById('tg-preview').textContent = previewText;
  document.getElementById('tg-send-result').style.display = 'none';
  document.getElementById('tg-send-modal').classList.add('open');
};

window.sendToTelegram = async function() {
  const btn = document.getElementById('btn-do-send');
  const resBox = document.getElementById('tg-send-result');
  btn.disabled = true; btn.textContent = '–ù–∞–¥—Å–∏–ª–∞—î–º–æ...';
  try {
    const r = await fetch(`https://api.telegram.org/bot${tgToken}/sendMessage`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: tgChatId, text: buildOrderMessage(), parse_mode:'HTML' })
    });
    const data = await r.json();
    resBox.style.display='block';
    if (data.ok) {
      resBox.style.background='#e8f5e8'; resBox.style.color='var(--sage)';
      resBox.innerHTML='‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –≤ Telegram!';
      btn.textContent='‚úì –ù–∞–¥—ñ—Å–ª–∞–Ω–æ';
      setTimeout(closeModals, 2000);
    } else {
      resBox.style.background='#fde8e8'; resBox.style.color='var(--red)';
      resBox.textContent='‚ùå –ü–æ–º–∏–ª–∫–∞ Telegram: ' + (data.description||'–Ω–µ–≤—ñ–¥–æ–º–∞');
      btn.disabled=false; btn.textContent='–ù–∞–¥—ñ—Å–ª–∞—Ç–∏';
    }
  } catch(e) {
    resBox.style.display='block'; resBox.style.background='#fde8e8'; resBox.style.color='var(--red)';
    resBox.textContent='‚ùå –ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞: ' + e.message;
    btn.disabled=false; btn.textContent='–ù–∞–¥—ñ—Å–ª–∞—Ç–∏';
  }
};

// ===== PRINT =====
window.printTable = function() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('uk-UA', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
  const timeStr = now.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });

  // –ì—Ä—É–ø—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ –∑–æ–Ω–∞—Ö
  const q = document.getElementById('search-inp').value.toLowerCase();
  let list = items.filter(it => {
    if (curZone !== 'all' && it.zone !== curZone) return false;
    if (q && !it.name.toLowerCase().includes(q)) return false;
    return true;
  });
  list.sort((a, b) => a.name.localeCompare(b.name, 'uk'));

  const byZone = {};
  list.forEach(it => {
    if (!byZone[it.zone]) byZone[it.zone] = [];
    byZone[it.zone].push(it);
  });

  let html = `
    <div class="print-header">
      <div class="print-logo">
        <span style="font-size:32px;">üêë</span>
        <div>
          <div class="print-title">–ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</div>
          <div class="print-subtitle">–ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ ¬∑ –†–µ—Å—Ç–æ—Ä–∞–Ω</div>
        </div>
      </div>
      <div class="print-meta">
        üìÖ ${dateStr}<br>
        üïê ${timeStr}<br>
        üì¶ –ü–æ–∑–∏—Ü—ñ–π: ${list.length}
      </div>
    </div>`;

  Object.entries(ZONES).forEach(([zoneName, zmeta]) => {
    const zItems = byZone[zoneName];
    if (!zItems || !zItems.length) return;

    html += `<div class="print-zone-block">
      <div class="print-zone-title">${zmeta.icon} ${zoneName}</div>
      <table class="print-table">
        <thead>
          <tr>
            <th class="col-name">–ù–∞–∑–≤–∞ –ø—Ä–æ–¥—É–∫—Ç—É</th>
            <th class="col-qty" style="text-align:center;">–ó–∞–ª–∏—à–æ–∫</th>
            <th class="col-note">–ù–æ—Ç–∞—Ç–∫–∞ / –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
          </tr>
        </thead>
        <tbody>
          ${zItems.map(it => {
            let qtyClass = 'col-qty';
            if (it.qty === 0) qtyClass += ' empty';
            else if (it.minQty > 0 && it.qty < it.minQty) qtyClass += ' low';
            return `<tr>
              <td class="col-name">${it.name}${it.note ? `<div style="font-size:10px;color:#999;margin-top:2px;">${it.note}</div>` : ''}</td>
              <td class="${qtyClass}">${it.qty} ${it.unit}${it.minQty > 0 ? `<div style="font-size:10px;font-weight:400;color:#aaa;">–º—ñ–Ω: ${it.minQty}</div>` : ''}</td>
              <td class="col-note"></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
  });

  html += `<div class="print-footer">
    <span>üêë –ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ‚Äî –†–µ—Å—Ç–æ—Ä–∞–Ω</span>
    <span>–ù–∞–¥—Ä—É–∫–æ–≤–∞–Ω–æ: ${dateStr}, ${timeStr}</span>
  </div>`;

  document.getElementById('print-area').innerHTML = html;
  window.print();
};

// ===== PRINT ZONE =====
window.printZone = function(zoneName) {
  const zmeta = ZONES[zoneName] || { icon: 'üì¶' };
  const zItems = items.filter(i => i.zone === zoneName).sort((a,b) => a.name.localeCompare(b.name, 'uk'));
  const now = new Date();
  const dateStr = now.toLocaleDateString('uk-UA', { day:'2-digit', month:'long', year:'numeric' });
  const timeStr = now.toLocaleTimeString('uk-UA', { hour:'2-digit', minute:'2-digit' });

  const rows = zItems.map(it => {
    let qtyClass = 'col-qty';
    if (it.qty === 0) qtyClass += ' empty';
    else if (it.minQty > 0 && it.qty < it.minQty) qtyClass += ' low';
    return `<tr>
      <td class="col-name">${it.name}${it.note?`<div style="font-size:10px;color:#999;margin-top:1px;">${it.note}</div>`:''}</td>
      <td class="${qtyClass}">${it.qty} ${it.unit}${it.minQty>0?`<div style="font-size:10px;font-weight:400;color:#aaa;">–º—ñ–Ω: ${it.minQty}</div>`:''}</td>
      <td class="col-note"></td>
    </tr>`;
  }).join('');

  document.getElementById('print-area').innerHTML = `
    <div class="print-header">
      <div class="print-logo">
        <span style="font-size:32px;">${zmeta.icon}</span>
        <div>
          <div class="print-title">${zoneName}</div>
          <div class="print-subtitle">–ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ¬∑ –†–µ—Å—Ç–æ—Ä–∞–Ω</div>
        </div>
      </div>
      <div class="print-meta">
        üìÖ ${dateStr}<br>üïê ${timeStr}<br>üì¶ –ü–æ–∑–∏—Ü—ñ–π: ${zItems.length}
      </div>
    </div>
    <table class="print-table">
      <thead>
        <tr>
          <th class="col-name">–ù–∞–∑–≤–∞ –ø—Ä–æ–¥—É–∫—Ç—É</th>
          <th class="col-qty" style="text-align:center;">–ó–∞–ª–∏—à–æ–∫</th>
          <th class="col-note">–ü–æ–º—ñ—Ç–∫–∞ / –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="print-footer">
      <span>üêë –ó–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ‚Äî –†–µ—Å—Ç–æ—Ä–∞–Ω</span>
      <span>–ù–∞–¥—Ä—É–∫–æ–≤–∞–Ω–æ: ${dateStr}, ${timeStr}</span>
    </div>`;
  window.print();
};
window.closeModals = function() { document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('open')); };
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeModals();}));

// ===== TOAST =====
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast '+type+' show';
  setTimeout(()=>t.classList.remove('show'), 3500);
}

// ===== SIDEBAR MOBILE TOGGLE =====
let sidebarOpen = false;
function initSidebar() {
  const content = document.getElementById('sidebar-content');
  const isMobile = window.innerWidth <= 768;
  if (isMobile) {
    content.style.maxHeight = '0px';
    content.style.opacity = '0';
    sidebarOpen = false;
  } else {
    content.style.maxHeight = '';
    content.style.opacity = '';
  }
}
window.toggleSidebar = function() {
  const content = document.getElementById('sidebar-content');
  const btn = document.getElementById('sidebar-btn');
  sidebarOpen = !sidebarOpen;
  if (sidebarOpen) {
    content.style.maxHeight = content.scrollHeight + 'px';
    content.style.opacity = '1';
    btn.classList.add('open');
  } else {
    content.style.maxHeight = '0px';
    content.style.opacity = '0';
    btn.classList.remove('open');
  }
};
window.addEventListener('resize', initSidebar);
initSidebar();

// Initial loading state
document.getElementById('tbody').innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:#aaa;font-size:13px;">üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ Firebase...</td></tr>`;

</script>
</body>
</html>
